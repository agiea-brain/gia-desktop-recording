<!doctype html>
<html>
    <head>
        <meta charset="UTF-8" />
        <meta name="application-name" content="Gia" />
        <title>Record Meeting?</title>
        <style>
            :root {
                --background: hsl(0, 0%, 100%);
                --foreground: hsl(0, 0%, 3.9%);
                --card: hsl(0, 0%, 100%);
                --card-foreground: hsl(0, 0%, 3.9%);
                --primary: hsl(0, 0%, 9%);
                --primary-foreground: hsl(0, 0%, 98%);
                --secondary: hsl(0, 0%, 96.1%);
                --secondary-foreground: hsl(0, 0%, 9%);
                --muted: hsl(0, 0%, 96.1%);
                --muted-foreground: hsl(0, 0%, 45.1%);
                --destructive: hsl(0, 84.2%, 60.2%);
                --destructive-foreground: hsl(0, 0%, 98%);
                --border: hsl(0, 0%, 89.8%);
                --input: hsl(0, 0%, 89.8%);
                --ring: hsl(0, 0%, 3.9%);
                --radius: 0.5rem;
            }

            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }
            
            body {
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
                background: var(--background);
                color: var(--foreground);
                overflow: hidden;
                -webkit-font-smoothing: antialiased;
                -moz-osx-font-smoothing: grayscale;
            }
            
            .titlebar {
                height: 36px;
                background: var(--background);
                border-bottom: 1px solid var(--border);
                display: flex;
                align-items: center;
                padding: 0 12px;
                -webkit-app-region: drag;
            }
            
            .window-controls {
                display: flex;
                gap: 8px;
                -webkit-app-region: no-drag;
            }
            
            .window-btn {
                width: 12px;
                height: 12px;
                min-width: 12px;
                min-height: 12px;
                max-width: 12px;
                max-height: 12px;
                padding: 0;
                margin: 0;
                border-radius: 50%;
                border: none;
                cursor: pointer;
                transition: opacity 0.15s;
                -webkit-appearance: none;
                appearance: none;
            }
            
            .window-btn:hover {
                opacity: 0.8;
            }
            
            .btn-minimize {
                background: #febc2e;
            }
            
            .container {
                padding: 24px;
                -webkit-app-region: no-drag;
            }

            .header-row {
                display: flex;
                align-items: center;
                gap: 12px;
                margin-bottom: 8px;
            }

            .gia-logo {
                width: 28px;
                height: 28px;
                border-radius: var(--radius);
                object-fit: contain;
                flex: 0 0 auto;
            }
            
            h1 {
                font-size: 18px;
                font-weight: 600;
                color: var(--foreground);
                letter-spacing: -0.025em;
            }
            
            p {
                font-size: 14px;
                color: var(--muted-foreground);
                margin-bottom: 24px;
                line-height: 1.5;
            }
            
            .recording-status {
                display: none;
                align-items: center;
                gap: 10px;
                margin-bottom: 20px;
                padding: 12px 14px;
                background: hsl(0, 84.2%, 97%);
                border: 1px solid hsl(0, 84.2%, 90%);
                border-radius: var(--radius);
                color: var(--destructive);
                font-size: 14px;
                font-weight: 500;
            }
            
            .recording-status.active {
                display: flex;
            }
            
            .recording-indicator {
                width: 8px;
                height: 8px;
                border-radius: 50%;
                background: var(--destructive);
                animation: pulse 1.5s ease-in-out infinite;
            }
            
            @keyframes pulse {
                0%, 100% { opacity: 1; }
                50% { opacity: 0.4; }
            }
            
            .button-group {
                display: flex;
                gap: 10px;
            }
            
            button {
                padding: 10px 20px;
                border-radius: var(--radius);
                font-size: 14px;
                font-weight: 500;
                cursor: pointer;
                transition: all 0.15s ease;
                flex: 1;
                display: inline-flex;
                align-items: center;
                justify-content: center;
            }
            
            .btn-primary {
                background: var(--primary);
                color: var(--primary-foreground);
                border: 1px solid var(--primary);
            }
            
            .btn-primary:hover:not(:disabled) {
                background: hsl(0, 0%, 15%);
                border-color: hsl(0, 0%, 15%);
            }
            
            .btn-primary:focus-visible {
                outline: 2px solid var(--ring);
                outline-offset: 2px;
            }
            
            .btn-secondary {
                background: var(--background);
                color: var(--foreground);
                border: 1px solid var(--border);
            }
            
            .btn-secondary:hover:not(:disabled) {
                background: var(--secondary);
                border-color: var(--input);
            }
            
            .btn-secondary:focus-visible {
                outline: 2px solid var(--ring);
                outline-offset: 2px;
            }
            
            .btn-destructive {
                background: var(--destructive);
                color: var(--destructive-foreground);
                border: 1px solid var(--destructive);
            }
            
            .btn-destructive:hover:not(:disabled) {
                background: hsl(0, 84.2%, 50%);
                border-color: hsl(0, 84.2%, 50%);
            }
            
            .btn-destructive:focus-visible {
                outline: 2px solid var(--ring);
                outline-offset: 2px;
            }
            
            button:disabled {
                opacity: 0.5;
                cursor: not-allowed;
            }

            .spinner {
                width: 16px;
                height: 16px;
                border: 2px solid currentColor;
                border-top-color: transparent;
                border-radius: 50%;
                animation: spin 0.6s linear infinite;
                margin-right: 8px;
            }

            @keyframes spin {
                to { transform: rotate(360deg); }
            }
        </style>
    </head>
    <body>
        <div class="titlebar">
            <div class="window-controls">
                <button class="window-btn btn-minimize" id="minimizeBtn" title="Minimize"></button>
            </div>
        </div>
        
        <div class="container">
            <div class="header-row">
                <img class="gia-logo" id="giaLogo" alt="Gia" />
                <h1 id="title">Record this meeting?</h1>
            </div>
            <p id="message">A meeting has been detected. Would you like Gia to record it?</p>
            
            <div class="recording-status" id="recordingStatus">
                <div class="recording-indicator"></div>
                <span>Recording in progress</span>
            </div>
            
            <div class="button-group" id="initialButtons">
                <button class="btn-secondary" id="declineBtn">No thanks</button>
                <button class="btn-primary" id="confirmBtn">Start recording</button>
            </div>
            
            <div class="button-group" id="recordingButtons" style="display: none;">
                <button class="btn-destructive" id="endBtn">End Recording</button>
            </div>
        </div>
        
        <script>
            const { ipcRenderer } = require('electron');

            // Route popup logs through main-process Logfire.
            (() => {
                const send = (level, ...args) =>
                    ipcRenderer.send("app-log", {
                        level,
                        args,
                        context: { source: "meeting-popup" },
                    });

                const original = {
                    log: console.log?.bind(console),
                    info: console.info?.bind(console),
                    warn: console.warn?.bind(console),
                    error: console.error?.bind(console),
                    debug: console.debug?.bind(console),
                };

                console.log = (...args) => {
                    original.log?.(...args);
                    send("info", ...args);
                };
                console.info = (...args) => {
                    original.info?.(...args);
                    send("info", ...args);
                };
                console.warn = (...args) => {
                    original.warn?.(...args);
                    send("warn", ...args);
                };
                console.error = (...args) => {
                    original.error?.(...args);
                    send("error", ...args);
                };
                console.debug = (...args) => {
                    original.debug?.(...args);
                    send("debug", ...args);
                };
            })();
            
            const titleEl = document.getElementById('title');
            const messageEl = document.getElementById('message');
            const recordingStatusEl = document.getElementById('recordingStatus');
            const initialButtonsEl = document.getElementById('initialButtons');
            const recordingButtonsEl = document.getElementById('recordingButtons');
            const giaLogoEl = document.getElementById('giaLogo');
            const confirmBtn = document.getElementById('confirmBtn');
            const declineBtn = document.getElementById('declineBtn');
            const endBtn = document.getElementById('endBtn');
            const minimizeBtn = document.getElementById('minimizeBtn');
            
            let isRecording = false;
            
            // Window controls
            minimizeBtn.addEventListener('click', () => {
                ipcRenderer.invoke('meeting-popup:minimize');
            });
            
            // Handle confirm button
            confirmBtn.addEventListener('click', async () => {
                if (isRecording) return;
                
                confirmBtn.disabled = true;
                declineBtn.disabled = true;
                confirmBtn.innerHTML = '<div class="spinner"></div>Starting...';
                
                try {
                    await ipcRenderer.invoke('meeting-popup:confirm-recording');
                } catch (error) {
                    console.error('Error starting recording:', error);
                    confirmBtn.disabled = false;
                    declineBtn.disabled = false;
                    confirmBtn.textContent = 'Start recording';
                }
            });
            
            // Handle decline button
            declineBtn.addEventListener('click', async () => {
                if (isRecording) return;
                await ipcRenderer.invoke('meeting-popup:decline-recording');
            });
            
            // Handle end recording button
            endBtn.addEventListener('click', async () => {
                if (!isRecording) return;
                
                endBtn.disabled = true;
                endBtn.innerHTML = '<div class="spinner"></div>Stopping...';
                
                try {
                    await ipcRenderer.invoke('meeting-popup:end-recording');
                } catch (error) {
                    console.error('Error ending recording:', error);
                    endBtn.disabled = false;
                    endBtn.textContent = 'End Recording';
                }
            });
            
            // Listen for recording state changes
            ipcRenderer.on('meeting-popup:recording-started', () => {
                isRecording = true;
                titleEl.textContent = 'Recording';
                messageEl.style.display = 'none';
                recordingStatusEl.classList.add('active');
                initialButtonsEl.style.display = 'none';
                recordingButtonsEl.style.display = 'flex';
                confirmBtn.disabled = false;
                declineBtn.disabled = false;
            });

            // Receive the Gia logo from main (data URL), so it works in packaged builds.
            ipcRenderer.on('meeting-popup:logo', (_event, payload) => {
                const dataUrl = payload?.dataUrl;
                if (typeof dataUrl === 'string' && dataUrl.length > 0) {
                    giaLogoEl.src = dataUrl;
                    giaLogoEl.style.display = 'block';
                } else {
                    giaLogoEl.style.display = 'none';
                }
            });
            
            ipcRenderer.on('meeting-popup:recording-ended', () => {
                // Window will be closed by main process
            });
        </script>
    </body>
</html>
